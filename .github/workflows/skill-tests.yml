name: Skill Combination Tests

on:
  pull_request:
    branches: [main]
    paths:
      - 'skills-engine/**'
      - '.opencode/skills/**'
      - 'src/**'

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      has_entries: ${{ steps.matrix.outputs.has_entries }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - run: bun install
      - name: Generate overlap matrix
        id: matrix
        run: |
          MATRIX=$(bun -e "import { generateMatrix } from './skills-engine/ci-matrix.ts'; console.log(JSON.stringify(generateMatrix('.opencode/skills')))")
          {
            echo "matrix<<MATRIX_EOF"
            echo "$MATRIX"
            echo "MATRIX_EOF"
          } >> "$GITHUB_OUTPUT"
          if [ "$MATRIX" = "[]" ]; then
            echo "has_entries=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_entries=true" >> "$GITHUB_OUTPUT"
          fi

  test-combinations:
    needs: generate-matrix
    if: needs.generate-matrix.outputs.has_entries == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        entry: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - run: bun install

      - name: Initialize pocketbrain dir
        run: bun -e "import { initNanoclawDir } from './skills-engine/index.ts'; initNanoclawDir();"

      - name: Apply skills in sequence
        run: |
          for skill in $(echo '${{ toJson(matrix.entry.skills) }}' | jq -r '.[]'); do
            echo "Applying skill: $skill"
            bun -e "import { applySkill } from './skills-engine/index.ts'; const result = await applySkill('.opencode/skills/$skill'); if (!result.success) { console.error(result.error || 'applySkill failed'); process.exit(1); }"
          done

      - name: Run skill tests
        run: bun test ".opencode/skills/**/tests/*.test.ts"

  skill-tests-summary:
    needs: [generate-matrix, test-combinations]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Report result
        run: |
          if [ "${{ needs.generate-matrix.outputs.has_entries }}" = "false" ]; then
            echo "No overlapping skills found. Skipped combination tests."
            exit 0
          fi
          if [ "${{ needs.test-combinations.result }}" = "success" ]; then
            echo "All skill combination tests passed."
          else
            echo "Some skill combination tests failed."
            exit 1
          fi

