# =============================================================================
# PocketBrain + Tailscale + Syncthing Stack
# =============================================================================

services:
  # ==========================================================================
  # Tailscale Sidecar
  # ==========================================================================
  tailscale:
    image: tailscale/tailscale:v1.78
    hostname: ${TS_HOSTNAME:-pocketbrain}
    restart: unless-stopped

    security_opt:
      - no-new-privileges:true

    environment:
      - TS_AUTHKEY=${TS_AUTHKEY:?TS_AUTHKEY is required. Get one at https://login.tailscale.com/admin/settings/keys}
      - TS_HOSTNAME=${TS_HOSTNAME:-pocketbrain}
      - TS_USERSPACE=true
      - TS_EXTRA_ARGS=${TS_EXTRA_ARGS:-}
      - TS_STATE_DIR=/var/lib/tailscale

    volumes:
      - pocketbrain-data:/var/lib/tailscale

    healthcheck:
      test: ["CMD-SHELL", "tailscale status > /dev/null 2>&1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # PocketBrain - AI Assistant
  # ==========================================================================
  pocketbrain:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_VERSION: ${APP_VERSION:-dev}
        GIT_SHA: ${GIT_SHA:-unknown}

    hostname: pocketbrain
    restart: unless-stopped
    user: "1000:1000"
    read_only: true

    security_opt:
      - no-new-privileges:true

    network_mode: "service:tailscale"
    depends_on:
      tailscale:
        condition: service_healthy

    environment:
      - OPENCODE_MODEL=${OPENCODE_MODEL:-}
      - OPENCODE_SERVER_URL=${OPENCODE_SERVER_URL:-}
      - OPENCODE_HOSTNAME=${OPENCODE_HOSTNAME:-127.0.0.1}
      - OPENCODE_PORT=${OPENCODE_PORT:-4096}
      - APP_NAME=${APP_NAME:-pocketbrain}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - ENABLE_WHATSAPP=${ENABLE_WHATSAPP:-false}
      - VAULT_ENABLED=true
      - VAULT_PATH=/data/vault
      - WHITELIST_PAIR_TOKEN=${WHITELIST_PAIR_TOKEN:-}
      - HEARTBEAT_INTERVAL_MINUTES=${HEARTBEAT_INTERVAL_MINUTES:-30}

    volumes:
      - pocketbrain-data:/data
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 100M
          mode: 1777
      - type: tmpfs
        target: /app/.data
        tmpfs:
          size: 128M
          mode: 755
      - type: tmpfs
        target: /home/bun/.cache
        tmpfs:
          size: 64M
          mode: 755
      - type: tmpfs
        target: /home/bun/.local
        tmpfs:
          size: 64M
          mode: 755
      - type: tmpfs
        target: /home/bun/.config
        tmpfs:
          size: 64M
          mode: 755

    healthcheck:
      test: ["CMD-SHELL", "pgrep -f '/app/pocketbrain' > /dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # Syncthing - File Synchronization
  # ==========================================================================
  syncthing:
    image: ${SYNCTHING_IMAGE:-syncthing/syncthing:2.0.14}
    hostname: pocketbrain-sync
    restart: unless-stopped

    security_opt:
      - no-new-privileges:true

    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-UTC}

    volumes:
      - syncthing-config:/var/syncthing
      - pocketbrain-data:/data

    ports:
      - "127.0.0.1:8384:8384"

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8384"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  pocketbrain-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}

  syncthing-config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/syncthing-config
