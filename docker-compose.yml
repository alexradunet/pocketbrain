services:
  pocketbrain:
    build:
      context: .
    image: pocketbrain-agent:latest
    container_name: pocketbrain
    env_file:
      - .env
    environment:
      WORKSPACE_DIR: /workspace
    volumes:
      - ./workspace:/workspace
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun

  dev:
    image: oven/bun:1
    working_dir: /app
    volumes:
      - ./:/app
    environment:
      WORKSPACE_DIR: /workspace
    command: sh -lc "bun install --frozen-lockfile && bun --watch src/index.ts"
    stdin_open: true
    tty: true
    profiles:
      - dev

  test:
    image: oven/bun:1
    working_dir: /app
    volumes:
      - ./:/app
    command: >
      sh -lc "apt-get update &&
      apt-get install -y --no-install-recommends git diffutils >/dev/null &&
      bun install --frozen-lockfile &&
      bun test src"
    profiles:
      - test
