# E2E test compose — runs PocketBrain with MockChannel + a bun test runner.
#
# Usage:
#   docker compose -f docker-compose.e2e.yml up --build --exit-code-from e2e-runner --abort-on-container-exit
#
# Required env vars (in shell or .env):
#   OPENCODE_API_KEY   — for the PocketBrain AI agent (OpenCode server)
#   ANTHROPIC_API_KEY  — for llmAssert() in the test runner (falls back to OPENCODE_API_KEY)
#   OPENCODE_MODEL     — optional, defaults to claude-sonnet-4-5-20251001

services:
  pocketbrain-e2e:
    build:
      context: .
      dockerfile: Dockerfile.e2e
    environment:
      CHANNEL: mock
      MOCK_CHANNEL_PORT: "3456"
      WORKSPACE_DIR: /workspace
      OPENCODE_API_KEY: ${OPENCODE_API_KEY}
      OPENCODE_MODEL: ${OPENCODE_MODEL:-claude-sonnet-4-5-20251001}
      OPENCODE_BASE_URL: ${OPENCODE_BASE_URL:-}
      ASSISTANT_NAME: "Andy"
      # Short idle timeout so sessions close quickly between tests
      IDLE_TIMEOUT: "30000"
    volumes:
      - e2e-workspace:/workspace
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3456/health"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 90s

  e2e-runner:
    image: oven/bun:1
    working_dir: /app
    volumes:
      - ./:/app
    environment:
      POCKETBRAIN_MOCK_URL: "http://pocketbrain-e2e:3456"
      # harness.ts falls back: ANTHROPIC_API_KEY || OPENCODE_API_KEY
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENCODE_API_KEY: ${OPENCODE_API_KEY:-}
    command: >
      sh -lc "bun install --frozen-lockfile &&
      bun test src/e2e"
    depends_on:
      pocketbrain-e2e:
        condition: service_healthy

volumes:
  e2e-workspace:
    # Fresh volume per compose project — clean state each run.
    # To reuse: docker compose -f docker-compose.e2e.yml down -v to reset.
